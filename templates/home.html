{% extends "base.html" %} 
{% block content1 %}
{% load static from staticfiles %}
<script src="{% static "js/jszip.min.js" %}" type="text/javascript"></script>
<script src="{% static "js/html2canvas.min.js" %}" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>

{% include 'base/dx.html' %}
{% load mathfilters %}

<style>
    .dx-row.dx-data-row .train {
        color: #bf4e6a;
        font-weight: bold;
    }
    .dx-row.dx-data-row .status {
        font-weight: bold;
    }
</style>

  <!-- Page-header opened -->
  <div class="page-header" style="margin:1px">
      <div class="page-leftheader">
          <h4 class="page-title mb-0">Hi, {{user.first_name}} welcome back!</h4>
          {% comment %} <small id="lastedit" class="text-muted mt-0">NCP Fleet Status Updated by {{lastedited.lastEditBy}} on {{lastedited.lastedited}}</small> {% endcomment %}
      </div>
      {% comment %} <div class="page-rightheader">
          <div class="d-flex mt-4 mt-xl-0 mt-lg-0">
              <div class="d-flex justify-content-center mr-5">
                  <div class="">
                      <span class="d-block">
                          <span class="text-muted fs-13">LIVE BMU AVAILABILITY</span>
                      </span>
                      <span id="bmu" class="h4 font-weight-semibold">
                          Currently: {{bmu_total}}
                      </span>
                  </div>
                  <div class="ml-3 mt-2">
                      <span class="sparkline_bar"></span>
                  </div>
              </div>
              <button id="print" type="button" onclick="location.href='{% url 'planning:rpt_ncpfs' %}'" class="btn btn-info btn-icon-text mb-2 mb-md-0"> 
                  <i class="fe fe-download-cloud "></i>
                  View Report
              </button>
          </div>
      </div> {% endcomment %}
  </div>
  <!-- Page-header closed -->

  <!--Conveyor-->
  {% comment %} <div class="row">
      <div class="col-xl-12 col-md-12 col-lg-12">
          <div class="card bg-dark1">
              <div class="js-conveyor-example">
                  <ul class="news-crypto">
                  {% if context %}
                  {% for unit in context %}
                      <li>
                          <div>
                              <div class="row">
                                  <div class="d-flex">
                                      <div class="">
                                          <img src="{% static "assets/images/crypto-currencies/regular/Dash.svg" %}" class="w-5 h-6 mt-1" alt="">
                                      </div>
                                      <div class="ml-3">
                                          <p class="text-white mb-1 fs-12">{{unit.equipment}}</p>
                                          {% if unit.status == 1 %}
                                              <div class="h5 m-0 fs-14 text-danger">
                                                  Unserviceable
                                              <span class="text-warning ml-2">
                                              <i class="ion-arrow-down-c mr-1">
                                              </i>{{unit.comments}}</span></div>
                                          {%else%}
                                          {% if unit.status == 2 %}
                                              <div class="h5 m-0 fs-14 text-warning">
                                                  Awaiting QPAC
                                              <span class="text-warning ml-2">
                                              <i class="ion-arrow-down-c mr-1">
                                              </i>{{unit.comments}}</span></div>
                                          {%else%}
                                          {% if unit.status == 3 %}
                                              <div class="h5 m-0 fs-14 text-success">
                                                  Serviceable
                                              <span class="text-warning ml-2">
                                              <i class="ion-arrow-up-c mr-1">
                                              </i>{{unit.comments}}</span></div>
                                          {%else%}
                                          {% if unit.status == 1 %}
                                              <div class="h5 m-0 fs-14 text-warning">
                                                  Expected
                                              <span class="text-warning ml-2">
                                              <i class="ion-arrow-up-c mr-1">
                                              </i>{{unit.comments}}</span></div>
                                          {%endif%}
                                          {%endif%}
                                          {%endif%}
                                          {%endif%}
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </li>
                  {% endfor %}
                  {%endif%}
                  </ul>
              </div>
          </div>
      </div>
  </div> {% endcomment %}


  <!--Stats-->
  {% comment %} <div class="row">
      <div class="col-xl-3 col-md-12 col-lg-6">
          <div class="card">
              <div class="card-body p-4">
                  <div class="d-flex">
                      <div>
                          <p class="mb-1"><img src="{% static "assets/images/crypto-currencies/regular/Dash.svg" %}" class="w-5 h-5 mr-1" alt="img">755/3</p>
                      </div>
                      <div class="ml-auto">
                          <p class="mb-1 fs-15 text-success"><i class="mr-1"></i>Fleet size: {{count7553}}</p>
                      </div>
                  </div>
                  <div class="d-flex mt-1 mb-1">
                      <div>
                          <p id="ct7553stp" class="mb-0 text-danger">{{count7553stp}} Unserviceable</p>
                          <h3 id="ct7553ser" class="mb-1">{{count7553ser}} Serviceable</h3>
                      </div>
                      <div class="ml-auto text-right">
                          <p id="ct7553exp" class=" mb-0 text-muted">{{count7553exp}} Expected</p>
                          <p id="ct7553req" class=" mb-0 text-muted"><span class="text-warning">{{count7553req.required}} Required</span></p>
                      </div>
                  </div>
                  <div class="progress h-1 mt-3 mb-2">
                      <div class="progress-bar bg-primary w-100 " role="progressbar"></div>
                  </div>
                  <small id="ct7553av" class="mb-0 text-muted">755/3 Availability<span class="float-right text-muted">{{ count7553ser|sub:count7553req.required }}</span></small>
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-md-12 col-lg-6">
          <div class="card">
              <div class="card-body p-4">
                  <div class="d-flex">
                      <div>
                          <p class="mb-1"><img src="{% static "assets/images/crypto-currencies/regular/Dash.svg" %}" class="w-5 h-5 mr-1" alt="img">755/4</p>
                      </div>
                      <div class="ml-auto">
                          <p class="mb-1 fs-15 text-success"><i class="mr-1"></i>Fleet size: {{count7554}}</p>
                      </div>
                  </div>
                  <div class="d-flex mt-1 mb-1">
                      <div>
                          <p id="ct7554stp" class="mb-0 text-danger">{{count7554stp}} Unserviceable</p>
                          <h3 id="ct7554ser" class="mb-1">{{count7554ser}} Serviceable</h3>
                      </div>
                      <div class="ml-auto text-right">
                          <p id="ct7554exp" class=" mb-0 text-muted">{{count7554exp}} Expected</p>
                          <p id="ct7554req" class=" mb-0 text-muted"><span class="text-warning">{{count7554req.required}} Required</span></p>
                      </div>
                  </div>
                  <div class="progress h-1 mt-3 mb-2">
                      <div class="progress-bar bg-secondary w-100 " role="progressbar"></div>
                  </div>
                  <small id="ct7554av" class="mb-0 text-muted">755/4 Availability<span class="float-right text-muted">{{ count7554ser|sub:count7554req.required }}</span></small>
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-md-12 col-lg-6">
          <div class="card">
              <div class="card-body p-4">
                  <div class="d-flex">
                      <div>
                          <p class="mb-1"><img src="{% static "assets/images/crypto-currencies/regular/Dash.svg" %}" class="w-5 h-5 mr-1" alt="img">745 EMU</p>
                      </div>
                      <div class="ml-auto">
                          <p class="mb-1 fs-15 text-success"><i class="mr-1"></i>Fleet size: {{count7450}}</p>
                      </div>
                  </div>
                  <div class="d-flex mt-1 mb-1">
                      <div>
                          <p id="ct7450stp" class="mb-0 text-danger">{{count7450stp}} Unserviceable</p>
                          <h3 id="ct7450ser" class="mb-1">{{count7450ser}} Serviceable</h3>
                      </div>
                      <div class="ml-auto text-right">
                          <p id="ct7450exp" class=" mb-0 text-muted">{{count7450exp}} Expected</p>
                          <p id="ct7450req" class=" mb-0 text-muted"><span class="text-warning">{{count7450req.required}} Required</span></p>
                      </div>
                  </div>
                  <div class="progress h-1 mt-3 mb-2">
                      <div class="progress-bar bg-warning w-100 " role="progressbar"></div>
                  </div>
                  <small id="ct7450av" class="mb-0 text-muted">745 EMU Availability<span class="float-right text-muted">{{ count7450ser|sub:count7450req.required }}</span></small>
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-md-12 col-lg-6">
          <div class="card">
              <div class="card-body p-4">
                  <div class="d-flex">
                      <div>
                          <p class="mb-1"><img src="{% static "assets/images/crypto-currencies/regular/Dash.svg" %}" class="w-5 h-5 mr-1" alt="img">745 AIR</p>
                      </div>
                      <div class="ml-auto">
                          <p class="mb-1 fs-15 text-success"><i class="mr-1"></i>Fleet size: {{count7451}}</p>
                      </div>
                  </div>
                  <div class="d-flex mt-1 mb-1">
                      <div>
                          <p id="ct7451stp" class="mb-0 text-danger">{{count7451stp}} Unserviceable</p>
                          <h3 id="ct7451ser" class="mb-1">{{count7451ser}} Serviceable</h3>
                      </div>
                      <div class="ml-auto text-right">
                          <p id="ct7451exp" class=" mb-0 text-muted">{{count7451exp}} Expected</p>
                          <p id="ct7451req" class=" mb-0 text-muted"><span class="text-warning">{{count7451req.required}} Required</span></p>
                      </div>
                  </div>
                  <div class="progress h-1 mt-3 mb-2">
                      <div class="progress-bar bg-info w-100 " role="progressbar"></div>
                  </div>
                  <small id="ct7451av" class="mb-0 text-muted">745 AIR Availability<span class="float-right text-muted">{{ count7451ser|sub:count7451req.required }}</span></small>
              </div>
          </div>
      </div>
  </div> {% endcomment %}
  <!-- row closed -->

<!--Grids here-->
<div class="row">
    <div class="col-lg-12">
        <div class="wideget-user-tab wideget-user-tab3 border-bottom">
            <div class="tab-menu-heading">
                <div class="tabs-menu1">
                    <ul class="nav">
                        <li class=""><a href="#tab-5" class="h5 active" data-toggle="tab">Orders</a></li>
                        <li><a href="#tab-6" data-toggle="tab" class="h5">Products</a></li>
                        <li><a href="#tab-7" data-toggle="tab" class="h5">Departments</a></li>
                        <li><a href="#tab-8" data-toggle="tab" class="h5">Customers</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="bg-white widget-user mb-0">
            <div class="card-body">
                <div class="border-0">
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab-5">
                            <div class="row">
                                <div class="col-lg-12 col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                    <h3 class="card-title">Orders</h3>
                                    <div class="card-options ">
                                        <a href="#" class="card-options-collapse" data-toggle="card-collapse"><i class="fe fe-chevron-up"></i></a>
                                        <a href="#" class="card-options-fullscreen" data-toggle="card-fullscreen"><i class="fe fe-maximize"></i></a>
                                        <a href="#" class="card-options-remove" data-toggle="card-remove"><i class="fe fe-x"></i></a>
                                    </div>
                                    </div>
                                    <div class="card-body">
                                    <div id="gridorders"></div>
                                    </div>
                                </div>
                                </div>

                            </div>
                        </div>
                        <div class="tab-pane" id="tab-6">
                            <div class="row">
                                <div class="col-lg-12 col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h4 class="card-title">Products</h4>
                                            <div class="card-options ">
                                                <a href="#" class="card-options-collapse" data-toggle="card-collapse"><i class="fe fe-chevron-up"></i></a>
                                                <a href="#" class="card-options-fullscreen" data-toggle="card-fullscreen"><i class="fe fe-maximize"></i></a>
                                                <a href="#" class="card-options-remove" data-toggle="card-remove"><i class="fe fe-x"></i></a>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="gridproducts"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-7">
                            <div class="row">
                                <div class="col-xl-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h4 class="card-title">Departments</h4>
                                            <div class="card-options ">
                                                <a href="#" class="card-options-collapse" data-toggle="card-collapse"><i class="fe fe-chevron-up"></i></a>
                                                <a href="#" class="card-options-fullscreen" data-toggle="card-fullscreen"><i class="fe fe-maximize"></i></a>
                                                <a href="#" class="card-options-remove" data-toggle="card-remove"><i class="fe fe-x"></i></a>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="griddepartments"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-8">
                            <div class="row">
                                <div class="col-xl-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h4 class="card-title">Customers</h4>
                                            <div class="card-options ">
                                                <a href="#" class="card-options-collapse" data-toggle="card-collapse"><i class="fe fe-chevron-up"></i></a>
                                                <a href="#" class="card-options-fullscreen" data-toggle="card-fullscreen"><i class="fe fe-maximize"></i></a>
                                                <a href="#" class="card-options-remove" data-toggle="card-remove"><i class="fe fe-x"></i></a>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="gridcustomers"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var csrftoken = Cookies.get('csrftoken');

    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

</script>

<script>
    let url = "/api/statusList/";
    let url1 = "/api/priorityList/";
    let url3 = '/api/orderList/';
    let url4 = "/api/departmentList/";
    let url5 = "/api/productList/";
    let url6 = "/api/customerList/";

    var fsDataOrders = new DevExpress.data.CustomStore({
        key: "id",
        load: function () {
            return sendRequest(url3, "GET");
        },
        insert: function(values) {
            return sendRequest(url3, "POST", values );
        },
        remove: function(key) {
            return sendRequest(url3 + key , "DELETE", key);
        },
        update: function(key, values) {
            return sendRequest(url3 + key + "/", "PUT", values);
        },
        onUpdating: function (key, values) {
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
            //values["rts_eta"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        },
        onInserting: function (values) {
            values["id"] = 0;
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
            values["createdBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["createdOn"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        }
    });

    let fsDataProducts = new DevExpress.data.CustomStore({
        key: "id",
        load: function () {
            return sendRequest(url5, "GET");
        },
        insert: function(values) {
            return sendRequest(url5, "POST", values );
        },
        remove: function(key) {
            return sendRequest(url5 + key , "DELETE", key);
        },
        update: function(key, values) {
            return sendRequest(url5 + key + "/", "PUT", values);
        },
        onUpdating: function (key, values) {
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        },
        onInserting: function (values) {
            values["id"] = 0;
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        }
    });

    let fsDataDepartments = new DevExpress.data.CustomStore({
        key: "id",
        load: function () {
            return sendRequest(url4, "GET");
        },
        insert: function(values) {
            return sendRequest(url4, "POST", values );
        },
        remove: function(key) {
            return sendRequest(url4 + key , "DELETE", key);
        },
        update: function(key, values) {
            return sendRequest(url4 + key + "/", "PUT", values);
        },
        onUpdating: function (key, values) {
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        },
        onInserting: function (values) {
            values["id"] = 0;
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        }
    });

    let fsDataCustomers = new DevExpress.data.CustomStore({
        key: "id",
        load: function () {
            return sendRequest(url6, "GET");
        },
        insert: function(values) {
            return sendRequest(url6, "POST", values );
        },
        remove: function(key) {
            return sendRequest(url6 + key , "DELETE", key);
        },
        update: function(key, values) {
            return sendRequest(url6 + key + "/", "PUT", values);
        },
        onUpdating: function (key, values) {
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        },
        onInserting: function (values) {
            values["id"] = 0;
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        }
    });

    let fsDatareq = new DevExpress.data.CustomStore({
        key: "id",
        load: function () {
            return sendRequest(url6, "GET");
        },
        insert: function(values) {
            return sendRequest(url6, "POST", values );
        },
        remove: function(key) {
            return sendRequest(url6 + key , "DELETE", key);
        },
        update: function(key, values) {
            return sendRequest(url6 + key + "/", "PUT", values);
        },
        onUpdating: function (key, values) {
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        },
        onInserting: function (values) {
            values["id"] = 0;
            values["lastEditBy"] = '{{ user.first_name }} {{user.last_name}}';
            values["lastedited"] = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss");
        }
    });

    $(function(){

      let dataGridOrders = $("#gridorders").dxDataGrid({
          key: "id",
          height: 400,
          dataSource: {
          store: fsDataOrders,
          reshapeOnPush: true
          },
          repaintChangesOnly: false,
          highlightChanges: true,
          scrolling: {
              mode: "virtual"
          },
          editing: {
          mode: "batch",
          allowAdding: true,
          allowUpdating: true,
          selectTextOnEditStart: true,
          startEditAction: "click",
          refreshMode: 'reshape',
          },
          allowColumnReordering: true,
          showBorders: true,
          rowAlternationEnabled: true,
          allowColumnResizing: true,
          columnResizingMode: "nextColumn",
          columnMinWidth: 50,
          columnAutoWidth: true,
          //focusedRowEnabled: true,
          hoverStateEnabled: true,
          dateSerializationFormat: "yyyy-MM-ddTHH:mm:ssZ",
          columns: [
              {
                  dataField: "id",
                  caption: "Order ID",
                  allowEditing: false,
                  cssClass: "train",
              },
              {
                  dataField: "customer",
                  caption: "Customer",
                  //sortOrder: "asc",
                  allowEditing: true,
                  lookup: {
                      dataSource: DevExpress.data.AspNet.createStore({
                      key: "id",
                      loadUrl: url6
                      }),
                      valueExpr: "id",
                      displayExpr: "name"
                  },
                  validationRules: [{ type: "required" }],
              },
              {
                  dataField: "subject",
                  caption: "Order Details",
                  allowEditing: true,
                  visible: true
              },
              {
                  dataField: "qty",
                  caption: "Qty",
                  allowEditing: true,
              },
              {
                  dataField: "status",
                  caption: "Status",
                  //sortOrder: "asc",
                  allowEditing: true,
                  lookup: {
                      dataSource: DevExpress.data.AspNet.createStore({
                      key: "id",
                      loadUrl: url
                      }),
                      valueExpr: "name",
                      displayExpr: "name"
                  },
                  validationRules: [{ type: "required" }],
              },
              {
                  dataField: "priority",
                  caption: "Priority",
                  //sortOrder: "asc",
                  allowEditing: true,
                  lookup: {
                      dataSource: DevExpress.data.AspNet.createStore({
                      key: "id",
                      loadUrl: url1
                      }),
                      valueExpr: "id",
                      displayExpr: "name"
                  },
                  //validationRules: [{ type: "required" }],
              },
              {
                  dataField: "start_date",
                  dataType: "datetime",
                  format: "dd-MM-yyyy HH:mm",
                  caption: "Start Datetime",
                  allowEditing: true
              },
              {
                  dataField: "due_date",
                  dataType: "datetime",
                  format: "dd-MM-yyyy HH:mm",
                  caption: "Due Datetime",
                  allowEditing: true
              },
          ],
          summary: {
              totalItems: [{
                  column: "id",
                  summaryType: "count"
              }]
          },
          onCellPrepared: function(e) {
              if(e.rowType === 'data') {
                  if(e.data.status === "Not Started") {
                      e.cellElement.css({ 'background-color': '#fb4c4c', 'color':'#ffffff' });
                  }
                  else
                  if(e.data.status === "Need Assistance") {
                      e.cellElement.css({ 'background-color': '#a5a19d' });
                  }
                  else
                  if(e.data.status === "Deferred") {
                      e.cellElement.css({ 'background-color': '#a5a19d' });
                  }
                  else
                  if(e.data.status === "In Progress") {
                      e.cellElement.css({ 'background-color': '#d2ac37' });
                  }
                  else
                  if(e.data.status === "Completed") {
                      e.cellElement.css({ 'background-color': '#abdb57' });
                  }
              }
          }
      }).dxDataGrid("instance");

      let dataGridProducts = $("#gridproducts").dxDataGrid({
          key: "id",
          height: 400,
          dataSource: {
          store: fsDataProducts,
          reshapeOnPush: true
          },
          repaintChangesOnly: false,
          highlightChanges: true,
          scrolling: {
              mode: "virtual"
          },
          editing: {
          mode: "batch",
          allowAdding: true,
          allowUpdating: true,
          selectTextOnEditStart: true,
          startEditAction: "click",
          refreshMode: 'reshape',
          },
          allowColumnReordering: true,
          showBorders: true,
          rowAlternationEnabled: true,
          allowColumnResizing: true,
          columnResizingMode: "nextColumn",
          columnMinWidth: 50,
          columnAutoWidth: true,
          //focusedRowEnabled: true,
          hoverStateEnabled: true,
          dateSerializationFormat: "yyyy-MM-ddTHH:mm:ssZ",
          columns: [
              {
                  dataField: "id",
                  caption: "ID",
                  allowEditing: false,
                  cssClass: "train",
              },
              {
                  dataField: "name",
                  caption: "Product Name",
                  allowEditing: true,
                  visible: true
              },
              {
                  dataField: "department",
                  caption: "Department",
                  //sortOrder: "asc",
                  allowEditing: true,
                  lookup: {
                      dataSource: DevExpress.data.AspNet.createStore({
                      key: "id",
                      loadUrl: url4
                      }),
                      valueExpr: "id",
                      displayExpr: "name"
                  },
                  validationRules: [{ type: "required" }],
              },
          ],
          summary: {
              totalItems: [{
                  column: "id",
                  summaryType: "count"
              }]
          },
      }).dxDataGrid("instance");

      let dataGridDepartments = $("#griddepartments").dxDataGrid({
          key: "id",
          height: 400,
          dataSource: {
          store: fsDataDepartments,
          reshapeOnPush: true
          },
          repaintChangesOnly: false,
          highlightChanges: true,
          scrolling: {
              mode: "virtual"
          },
          editing: {
          mode: "batch",
          allowAdding: true,
          allowUpdating: true,
          selectTextOnEditStart: true,
          startEditAction: "click",
          refreshMode: 'reshape',
          },
          rowAlternationEnabled: true,
          allowColumnResizing: true,
          columnResizingMode: "nextColumn",
          columnMinWidth: 50,
          columnAutoWidth: true,
          //focusedRowEnabled: true,
          hoverStateEnabled: true,
          dateSerializationFormat: "yyyy-MM-ddTHH:mm:ssZ",
          columns: [
              {
                  dataField: "id",
                  caption: "ID",
                  allowEditing: false,
                  cssClass: "train",
              },
              {
                  dataField: "name",
                  caption: "Name",
                  allowEditing: true,
                  visible: true
              },
          ],
          summary: {
              totalItems: [{
                  column: "id",
                  summaryType: "count"
              }]
          },
      }).dxDataGrid("instance");

      let dataGridCustomers = $("#gridcustomers").dxDataGrid({
          key: "id",
          height: 400,
          dataSource: {
          store: fsDataCustomers,
          reshapeOnPush: true
          },
          repaintChangesOnly: false,
          highlightChanges: true,
          scrolling: {
              mode: "virtual"
          },
          editing: {
          mode: "batch",
          allowAdding: true,
          allowUpdating: true,
          selectTextOnEditStart: true,
          startEditAction: "click",
          refreshMode: 'reshape',
          },
          rowAlternationEnabled: true,
          allowColumnResizing: true,
          columnResizingMode: "nextColumn",
          columnMinWidth: 50,
          columnAutoWidth: true,
          //focusedRowEnabled: true,
          hoverStateEnabled: true,
          dateSerializationFormat: "yyyy-MM-ddTHH:mm:ssZ",
          columns: [
              {
                  dataField: "id",
                  caption: "ID",
                  allowEditing: false,
                  cssClass: "train",
              },
              {
                  dataField: "name",
                  caption: "Name",
                  allowEditing: true,
                  visible: true
              },
              {
                  dataField: "address",
                  caption: "Address",
                  allowEditing: true,
                  visible: true
              },
              {
                  dataField: "postcode",
                  caption: "Post Code",
                  allowEditing: true,
                  visible: true
              },
              {
                  dataField: "phone",
                  caption: "Phone",
                  allowEditing: true,
                  visible: true
              },
          ],
          summary: {
              totalItems: [{
                  column: "name",
                  summaryType: "count"
              }]
          },
      }).dxDataGrid("instance");
      });

      var resizingModes = ["nextColumn", "widget"];

      $("#select-resizing").dxSelectBox({
          items: resizingModes,
          value: resizingModes[0],
          width: 250,
          onValueChanged: function(data) {
              dataGrid.option("columnResizingMode", data.value);  
          },
      });

      function sendRequest(url, method, data) {
          var d = $.Deferred();
          method = method || "GET";

          logRequest('{{ user.first_name }} {{user.last_name}}', method, url, data);

          $.ajax(url, {
              method: method || "GET",
              data: data
          }).done(function(result) {

              d.resolve(method === "GET" ? result : result);
          });
          return d.promise();
      }
      function logRequest(user, method, url, data) {
          var args = Object.keys(data || {}).map(function(key) {
              return key + "=" + data[key];
          }).join(" ");

          var logList = $("#requests ul"),
              datetime = DevExpress.localization.formatDate(new Date(), "yyyy-MM-dd HH:mm:ss"),
              newItem = $("<li>").text([datetime,user, method, url.slice(URL.length), args].join(" "));
          
          logList.prepend(newItem);
          //saveAudit(method, url.slice(URL.length) + args);
      }

      let audUrl = '/api/auditList/';
      function saveAudit(method, url){
          values = {};
          values["id"] = 0;
          values["page"] = "NCP Fleet Status Page";
          values["user"]= '{{ user.first_name }} {{user.last_name}}';
          values["equipment"]= '';
          values["action"]= method;
          values["description"]= url;

          $.ajax({
              contentType: "application/json",
              url: audUrl,
              method: "POST",
              data: JSON.stringify(values)
          });
      }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function startWebsocket(){
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var ws_path = ws_scheme + '://' + window.location.host + "/frontend/stream/";
    //console.log("Connecting to " + ws_path);
    //var socket = new ReconnectingWebSocket(ws_path);
    let socket = new WebSocket(ws_path);

    // Handle incoming messages
    socket.onmessage = function (message) {

        // Decode the JSON
        console.log("Got websocket message " + message.data);
        var data = JSON.parse(message.data);

        if(data.event == "New_Order")
        {
            if(data.id !=="")
            {
              showAlert(data.username+' Added a New Order '+data.id+'. '+data.subject,"alert-info", false);
              $.growl.notice({
                  message: data.username+ ' Added a New Order '+data.id+' Status: '+data.status
              });
              swal({
                  title: data.username,
                  text: 'Added New Order: '+data.id+':'+data.subject+'. Priority: '+data.priority+' - Status: '+data.status,
                  timer: 5000,
                  showConfirmButton: false
              });
            }
            //updateStats(data);
            //updateGrids(data);

            //swal({
            //    title: data.username,
            //    text: 'Changed '+data.equipment+' status: '+data.comments,
            //    timer: 2500,
            //    showConfirmButton: false
		        //});

        }
        else
        {
            swal({
              title: data.username,
              text: 'UPDATED Order No: '+data.id+'. Desc: '+data.subject+'. Priority: '+data.priority+' - Status: '+data.status,
              timer: 4000,
              showConfirmButton: true
            });

            showAlert(data.username+' Updated Order No: '+data.id+'. Desc: '+data.subject,"alert-info", false);
        }

        if (data.error) {
                showAlert('Error: '+data.error, "alert-danger", false);
            return;
        }
    };

    // Helpful debugging
    socket.onopen = function () {
      //console.log("Connected to main notification socket");
      //$.growl.notice({
      //  message: "Connected to main notifications thread"
      //});
      showAlert('Connected to main notifications thread',"alert-success", false);
    };
    socket.onclose = function () {
      //console.log("Disconnected from main notification socket");
      $.growl.error({
        message: "Disconnected from main notifications thread"
      });
      //showAlert('Disconnected from main notifications thread',"alert-warning", false);
    }

    function updateStats(data){

        $('#lastedit').html('Status Updated by '+data.username+' on '+ getDate(data.lastedit));
        $('#bmu').html('Currently: '+data.bmu_total);
        
        $('#ct7553ser').html(data.count7553ser+' Serviceable');
        $('#ct7553stp').html(data.count7553stp+' Unserviceable');
        $('#ct7553exp').html(data.count7553exp+' Expected');
        $('#ct7553req').html('<span class="text-warning">'+data.count7553req.required+' Required</span>');
        $('#ct7553av').html('755/3 Availability <span class="float-right text-muted">' + (parseInt(data.count7553ser) - parseInt(data.count7553req.required)) + '</span>');
        
        $('#ct7554ser').html(data.count7554ser+' Serviceable');
        $('#ct7554stp').html(data.count7554stp+' Unserviceable');
        $('#ct7554exp').html(data.count7554exp+' Expected');
        $('#ct7554req').html('<span class="text-warning">'+data.count7554req.required+' Required</span>');
        $('#ct7554av').html('755/4 Availability <span class="float-right text-muted">' + (parseInt(data.count7554ser) - parseInt(data.count7554req.required)) + '</span>');

        $('#ct7450ser').html(data.count7450ser+' Serviceable');
        $('#ct7450stp').html(data.count7450stp+' Unserviceable');
        $('#ct7450exp').html(data.count7450exp+' Expected');
        $('#ct7450req').html('<span class="text-warning">'+data.count7450req.required+' Required</span>');
        $('#ct7450av').html('745 EMU Availability <span class="float-right text-muted">' + (parseInt(data.count7450ser) - parseInt(data.count7450req.required)) + '</span>');

        $('#ct7451ser').html(data.count7451ser+' Serviceable');
        $('#ct7451stp').html(data.count7451stp+' Unserviceable');
        $('#ct7451exp').html(data.count7451exp+' Expected');
        $('#ct7451req').html('<span class="text-warning">'+data.count7451req.required+' Required</span>');
        $('#ct7451av').html('745 AIR Availability <span class="float-right text-muted">' + (parseInt(data.count7451ser) - parseInt(data.count7451req.required)) + '</span>');

    };

    function updateGrids(data){
        if(data.equipment.substr(0,4)=="7553")
        {
            fsDataOrders.push([{ type: "update", key: data.id, data: { comments : data.comments, rts_eta : getDate(data.rts_eta), status : data.status} }]);
        }
        if(data.equipment.substr(0,4)=="7554")
        {
            fsData7554.push([{ type: "update", key: data.id, data: {comments : data.comments, rts_eta : getDate(data.rts_eta), status : data.status} }]);
        }

        if(data.equipment.substr(0,4)=="7450")
        {
            fsDataProducts.push([{ type: "update", key: data.id, data: { comments :data.comments,rts_eta : getDate(data.rts_eta), status : data.status} }]);
        }

        if(data.equipment.substr(0,4)=="7451")
        {
            fsDataDepartments.push([{ type: "update", key: data.id, data: { comments :data.comments, rts_eta : getDate(data.rts_eta), status : data.status} }]);
        }

        if(data.equipment.substr(0,2)=="NC")
        {
            fsDataCustomers.push([{ type: "update", key: data.id, data: { comments :data.comments, rts_eta : getDate(data.rts_eta), status: data.status} }]);
        }
        var dsreq = $("#gridreq").dxDataGrid("getDataSource");
            dsreq.reload();
    };

    function getDate(value){
        if(value !=='null')
        {
            var dt = JSON.parse(value).substr(0,19);
            //console.log(dt);
            return  new Date(dt); //DevExpress.localization.formatDate(dt, "yyyy-MM-ddTHH:mm:ss");
        }
        return "";
    }

  });
</script>

{% endblock  %}